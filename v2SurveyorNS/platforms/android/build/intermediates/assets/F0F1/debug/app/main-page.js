"use strict";
/*
In NativeScript, a file with the same name as an XML file is known as
a code-behind file. The code-behind is a great place to place your view
logic, and to set up your pageâ€™s data binding.
*/
Object.defineProperty(exports, "__esModule", { value: true });
var cameraPreview = require("./nativescript-camera-preview/nativescript-camera-preview");
var rotVector = require("./nativescript-rotation-vector/index");
var app = require("application");
var platform = require("platform");
var orientation = require("nativescript-screen-orientation");
var params = require("./nativescript-fov/nativescript-fov");
var permissions = require("nativescript-permissions");
var charts = require("./nativescript-chart/chart");
var enums_1 = require("ui/enums");
var crosshair;
var doubleline;
var upperText;
var lowerText;
var capturebtn;
var recordstop;
var x, y, z;
var page;
var isOn = false;
var isFirst = true;
// let filters;
var OUTER_CIRCLE_DIAMETER = 2;
var ANGLE_BETWEEN_LINES = 10;
var yTranslate = app.ios ? -20 : 0;
var resize = function () {
    var scaleCrosshair = params.degrees2Scale(OUTER_CIRCLE_DIAMETER, crosshair.getMeasuredHeight());
    crosshair.scaleX = scaleCrosshair;
    crosshair.scaleY = scaleCrosshair;
    crosshair.translateY = yTranslate;
    var scaleDoubleLine = params.degrees2Scale(ANGLE_BETWEEN_LINES, doubleline.getMeasuredHeight());
    doubleline.scaleX = scaleDoubleLine;
    doubleline.scaleY = scaleDoubleLine;
    if (app.ios) {
        var cameraView = page.getViewById("placeholder-view");
        cameraView.animate({
            scale: {
                x: platform.screen.mainScreen.heightPixels / cameraView.getMeasuredHeight(),
                y: platform.screen.mainScreen.heightPixels / cameraView.getMeasuredHeight()
            },
            translate: {
                x: 0,
                y: app.ios ? -10 : 0
            },
            duration: 2000
        });
    }
};
var updateCallback2 = function () {
    if (isOn)
        charts.updateGraph(x, y);
    if (isFirst) {
        resize();
        isFirst = false;
    }
    crosshair.rotate = -z;
    var distanceFromCenter = params.pixels2Dp((params.degrees2Pixels((-y % ANGLE_BETWEEN_LINES)
        - ANGLE_BETWEEN_LINES / 2 * (y > 0 ? -1 : 1))));
    doubleline.translateX = Math.sin(z * Math.PI / 180) * distanceFromCenter;
    doubleline.translateY = Math.cos(z * Math.PI / 180) * distanceFromCenter + yTranslate;
    doubleline.rotate = -z;
    var dist = params.degrees2Scale(ANGLE_BETWEEN_LINES, doubleline.getMeasuredHeight()) * params.degrees2Pixels(ANGLE_BETWEEN_LINES / 2);
    lowerText.text = 10 * Math.floor(-y / 10);
    lowerText.translateX = Math.sin(z * Math.PI / 180) * (distanceFromCenter + dist);
    lowerText.translateY = Math.cos(z * Math.PI / 180) * (distanceFromCenter + dist) + yTranslate;
    lowerText.rotate = -z;
    upperText.text = 10 * Math.floor((-y + 10) / 10);
    upperText.translateX = Math.sin(z * Math.PI / 180) * (distanceFromCenter - dist);
    upperText.translateY = Math.cos(z * Math.PI / 180) * (distanceFromCenter - dist) + yTranslate;
    upperText.rotate = -z;
};
var rotationCallback = function (data) {
    //console.log("x: " + data.x + " y: " + data.y + " z: " + data.z);
    x = data.x;
    y = data.y;
    z = data.z;
    if (app.ios)
        updateCallback2(); // ios doesn't seem to expose a callback for every frame update in the camera preview; therefore, we'll hop on the rotation callback
};
// export function showSideDrawer(args: EventData) {
//     console.log("Show SideDrawer tapped.");
// }
//TODO: split up the code
function onLoaded(args) {
    orientation.setCurrentOrientation("portrait", function () { });
    if (app.android && platform.device.sdkVersion >= '21') {
        var View = android.view.View;
        var window_1 = app.android.startActivity.getWindow();
        // set the status bar to Color.Transparent
        // window.setStatusBarColor(0x000000);
        var decorView = window_1.getDecorView();
        decorView.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE
            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION // hide nav bar
            | View.SYSTEM_UI_FLAG_FULLSCREEN // hide status bar
            | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY);
    }
    cameraPreview.onLoaded(args, "placeholder-view");
}
exports.onLoaded = onLoaded;
function onCreatingView(args) {
    charts.initGraph(page);
    if (app.android) {
        permissions.requestPermission(android["Manifest"].permission.CAMERA, "I need these permissions for the viewfinder")
            .then(function () {
            console.log("Woo Hoo, I have the power!");
        })
            .catch(function () {
            console.log("Uh oh, no permissions - plan B time!");
        });
    }
    if (app.android)
        params.initialize();
    cameraPreview.onCreatingView(updateCallback2, args);
    if (app.ios !== undefined)
        params.initialize();
    rotVector.startRotUpdates(rotationCallback, { sensorDelay: "game" });
    var maxSize = cameraPreview.getMaxSize();
    params.setVars(maxSize[0], maxSize[1]);
    // console.log(params.getVerticalFOV() + " " + params.getHorizontalFOV());
}
exports.onCreatingView = onCreatingView;
function onTakeShot(args) {
    cameraPreview.onTakeShot(args);
    isOn = !isOn;
    capturebtn.animate({
        scale: { x: 1.2, y: 1.2 },
        duration: 100
    }).then(function () {
        capturebtn.animate({
            scale: { x: 1, y: 1 },
            duration: 300,
            curve: enums_1.AnimationCurve.spring
        });
        recordstop.src = isOn ? "res://stop" : "res://record";
    });
    console.log("el: " + y);
}
exports.onTakeShot = onTakeShot;
function navigatingTo(args) {
    page = args.object;
    crosshair = page.getViewById("crosshair");
    doubleline = page.getViewById("doubleline");
    upperText = page.getViewById("upperText");
    lowerText = page.getViewById("lowerText");
    capturebtn = page.getViewById("capturebtn");
    recordstop = page.getViewById("recordstop");
}
exports.navigatingTo = navigatingTo;
app.on(app.resumeEvent, function (args) {
    rotVector.startRotUpdates(rotationCallback, { sensorDelay: "game" });
    cameraPreview.onResume();
});
app.on(app.suspendEvent, function (args) {
    cameraPreview.onPause();
    rotVector.stopRotUpdates();
    charts.onExit();
});
app.on(app.exitEvent, function (args) {
    console.log("On Exitting");
    rotVector.stopRotUpdates();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi1wYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFpbi1wYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7OztFQUlFOztBQUlGLHlGQUEyRjtBQUMzRixnRUFBa0U7QUFDbEUsaUNBQW1DO0FBR25DLG1DQUFxQztBQUNyQyw2REFBK0Q7QUFDL0QsNERBQThEO0FBQzlELHNEQUF3RDtBQUN4RCxtREFBcUQ7QUFDckQsa0NBQXdDO0FBRXhDLElBQUksU0FBYyxDQUFDO0FBQ25CLElBQUksVUFBZSxDQUFDO0FBQ3BCLElBQUksU0FBYyxDQUFDO0FBQ25CLElBQUksU0FBYyxDQUFDO0FBQ25CLElBQUksVUFBZSxDQUFDO0FBQ3BCLElBQUksVUFBZSxDQUFDO0FBQ3BCLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7QUFDWixJQUFJLElBQUksQ0FBQztBQUNULElBQUksSUFBSSxHQUFZLEtBQUssQ0FBQztBQUMxQixJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUM7QUFDbkIsZUFBZTtBQUVmLElBQU0scUJBQXFCLEdBQUcsQ0FBQyxDQUFDO0FBQ2hDLElBQU0sbUJBQW1CLEdBQUcsRUFBRSxDQUFDO0FBQy9CLElBQU0sVUFBVSxHQUFHLEdBQUcsQ0FBQyxHQUFHLEdBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBRXBDLElBQU0sTUFBTSxHQUFHO0lBQ2IsSUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxTQUFTLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO0lBQ2xHLFNBQVMsQ0FBQyxNQUFNLEdBQUcsY0FBYyxDQUFDO0lBQ2xDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsY0FBYyxDQUFDO0lBQ2xDLFNBQVMsQ0FBQyxVQUFVLEdBQUcsVUFBVSxDQUFDO0lBRWxDLElBQU0sZUFBZSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsbUJBQW1CLEVBQUUsVUFBVSxDQUFDLGlC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LElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDMUMsVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDNUMsU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDMUMsU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUM7SUFDMUMsVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDNUMsVUFBVSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDaEQsQ0FBQztBQVJELG9DQVFDO0FBRUQsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLFVBQVMsSUFBSTtJQUNuQyxTQUFTLENBQUMsZUFBZSxDQUFDLGdCQUFnQixFQUFHLEVBQUUsV0FBVyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUM7SUFDdEUsYUFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDO0FBQzNCLENBQUMsQ0FBQyxDQUFDO0FBQ0gsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsWUFBWSxFQUFFLFVBQVMsSUFBSTtJQUNwQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDeEIsU0FBUyxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQzNCLE1BQU0sQ0FBQyxNQUFNLEVBQUUsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQztBQUNILEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxVQUFTLElBQUk7SUFDakMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUMzQixTQUFTLENBQUMsY0FBYyxFQUFFLENBQUM7QUFDN0IsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxyXG5JbiBOYXRpdmVTY3JpcHQsIGEgZmlsZSB3aXRoIHRoZSBzYW1lIG5hbWUgYXMgYW4gWE1MIGZpbGUgaXMga25vd24gYXNcclxuYSBjb2RlLWJlaGluZCBmaWxlLiBUaGUgY29kZS1iZWhpbmQgaXMgYSBncmVhdCBwbGFjZSB0byBwbGFjZSB5b3VyIHZpZXdcclxubG9naWMsIGFuZCB0byBzZXQgdXAgeW91ciBwYWdl4oCZcyBkYXRhIGJpbmRpbmcuXHJcbiovXHJcblxyXG5pbXBvcnQgeyBFdmVudERhdGEgfSBmcm9tICdkYXRhL29ic2VydmFibGUnO1xyXG5pbXBvcnQgeyBQYWdlIH0gZnJvbSAndWkvcGFnZSc7XHJcbmltcG9ydCAqIGFzIGNhbWVyYVByZXZpZXcgZnJvbSAnLi9uYXRpdmVzY3JpcHQtY2FtZXJhLXByZXZpZXcvbmF0aXZlc2NyaXB0LWNhbWVyYS1wcmV2aWV3JztcclxuaW1wb3J0ICogYXMgcm90VmVjdG9yIGZyb20gXCIuL25hdGl2ZXNjcmlwdC1yb3RhdGlvbi12ZWN0b3IvaW5kZXhcIjtcclxuaW1wb3J0ICogYXMgYXBwIGZyb20gXCJhcHBsaWNhdGlvblwiO1xyXG5pbXBvcnQgKiBhcyBmcmFtZU1vZHVsZSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy91aS9mcmFtZVwiO1xyXG5pbXBvcnQgKiBhcyBhbmltYXRpb24gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvYW5pbWF0aW9uXCI7XHJcbmltcG9ydCAqIGFzIHBsYXRmb3JtIGZyb20gXCJwbGF0Zm9ybVwiO1xyXG5pbXBvcnQgKiBhcyBvcmllbnRhdGlvbiBmcm9tIFwibmF0aXZlc2NyaXB0LXNjcmVlbi1vcmllbnRhdGlvblwiO1xyXG5pbXBvcnQgKiBhcyBwYXJhbXMgZnJvbSBcIi4vbmF0aXZlc2NyaXB0LWZvdi9uYXRpdmVzY3JpcHQtZm92XCI7XHJcbmltcG9ydCAqIGFzIHBlcm1pc3Npb25zIGZyb20gXCJuYXRpdmVzY3JpcHQtcGVybWlzc2lvbnNcIjtcclxuaW1wb3J0ICogYXMgY2hhcnRzIGZyb20gXCIuL25hdGl2ZXNjcmlwdC1jaGFydC9jaGFydFwiO1xyXG5pbXBvcnQge0FuaW1hdGlvbkN1cnZlfSBmcm9tIFwidWkvZW51bXNcIjtcclxuXHJcbmxldCBjcm9zc2hhaXI6IGFueTtcclxubGV0IGRvdWJsZWxpbmU6IGFueTtcclxubGV0IHVwcGVyVGV4dDogYW55O1xyXG5sZXQgbG93ZXJUZXh0OiBhbnk7XHJcbmxldCBjYXB0dXJlYnRuOiBhbnk7XHJcbmxldCByZWNvcmRzdG9wOiBhbnk7XHJcbmxldCB4LCB5LCB6O1xyXG5sZXQgcGFnZTtcclxubGV0IGlzT246IGJvb2xlYW4gPSBmYWxzZTtcclxubGV0IGlzRmlyc3QgPSB0cnVlO1xyXG4vLyBsZXQgZmlsdGVycztcclxuXHJcbmNvbnN0IE9VVEVSX0NJUkNMRV9ESUFNRVRFUiA9IDI7XHJcbmNvbnN0IEFOR0xFX0JFVFdFRU5fTElORVMgPSAxMDtcclxuY29uc3QgeVRyYW5zbGF0ZSA9IGFwcC5pb3M/IC0yMCA6IDA7XHJcblxyXG5jb25zdCByZXNpemUgPSBmdW5jdGlvbigpIHtcclxuICBjb25zdCBzY2FsZUNyb3NzaGFpciA9IHBhcmFtcy5kZWdyZWVzMlNjYWxlKE9VVEVSX0NJUkNMRV9ESUFNRVRFUiwgY3Jvc3NoYWlyLmdldE1lYXN1cmVkSGVpZ2h0KCkpO1xyXG4gIGNyb3NzaGFpci5zY2FsZVggPSBzY2FsZUNyb3NzaGFpcjtcclxuICBjcm9zc2hhaXIuc2NhbGVZID0gc2NhbGVDcm9zc2hhaXI7XHJcbiAgY3Jvc3NoYWlyLnRyYW5zbGF0ZVkgPSB5VHJhbnNsYXRlO1xyXG5cclxuICBjb25zdCBzY2FsZURvdWJsZUxpbmUgPSBwYXJhbXMuZGVncmVlczJTY2FsZShBTkdMRV9CRVRXRUVOX0xJTkVTLCBkb3VibGVsaW5lLmdldE1lYXN1cmVkSGVpZ2h0KCkpO1xyXG4gIGRvdWJsZWxpbmUuc2NhbGVYID0gc2NhbGVEb3VibGVMaW5lO1xyXG4gIGRvdWJsZWxpbmUuc2NhbGVZID0gc2NhbGVEb3VibGVMaW5lO1xyXG5cclxuICBpZiAoYXBwLmlvcykge1xyXG4gICAgbGV0IGNhbWVyYVZpZXcgPSBwYWdlLmdldFZpZXdCeUlkKFwicGxhY2Vob2xkZXItdmlld1wiKTtcclxuICAgIGNhbWVyYVZpZXcuYW5pbWF0ZSh7XHJcbiAgICAgIHNjYWxlOiB7XHJcbiAgICAgICAgeDogcGxhdGZvcm0uc2NyZWVuLm1haW5TY3JlZW4uaGVpZ2h0UGl4ZWxzL2NhbWVyYVZpZXcuZ2V0TWVhc3VyZWRIZWlnaHQoKSxcclxuICAgICAgICB5OiBwbGF0Zm9ybS5zY3JlZW4ubWFpblNjcmVlbi5oZWlnaHRQaXhlbHMvY2FtZXJhVmlldy5nZXRNZWFzdXJlZEhlaWdodCgpXHJcbiAgICAgIH0sXHJcbiAgICAgIHRyYW5zbGF0ZToge1xyXG4gICAgICAgIHg6IDAsXHJcbiAgICAgICAgeTogYXBwLmlvcz8gLTEwIDogMFxyXG4gICAgICB9LFxyXG4gICAgICBkdXJhdGlvbjogMjAwMFxyXG4gICAgfSk7XHJcbiAgfVxyXG59O1xuY29uc3QgdXBkYXRlQ2FsbGJhY2syID0gZnVuY3Rpb24oKSB7XG4gIGlmKGlzT24pIGNoYXJ0cy51cGRhdGVHcmFwaCh4LHkpO1xuICBpZihpc0ZpcnN0KSB7XG4gICAgcmVzaXplKCk7XG4gICAgaXNGaXJzdCA9IGZhbHNlO1xuICB9XG4gIGNyb3NzaGFpci5yb3RhdGUgPSAtejtcbiAgY29uc3QgZGlzdGFuY2VGcm9tQ2VudGVyID0gcGFyYW1zLnBpeGVsczJEcCgocGFyYW1zLmRlZ3JlZXMyUGl4ZWxzKCgteSAlIEFOR0xFX0JFVFdFRU5fTElORVMpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLSBBTkdMRV9CRVRXRUVOX0xJTkVTLzIgKiAoeT4wPyAtMTogMSkpKSk7XG4gIGRvdWJsZWxpbmUudHJhbnNsYXRlWCA9IE1hdGguc2luKHoqTWF0aC5QSS8xODApKmRpc3RhbmNlRnJvbUNlbnRlcjtcbiAgZG91YmxlbGluZS50cmFuc2xhdGVZID0gIE1hdGguY29zKHoqTWF0aC5QSS8xODApKmRpc3RhbmNlRnJvbUNlbnRlciArIHlUcmFuc2xhdGU7XG4gIGRvdWJsZWxpbmUucm90YXRlID0gLXo7XG5cbiAgY29uc3QgZGlzdCA9IHBhcmFtcy5kZWdyZWVzMlNjYWxlKEFOR0xFX0JFVFdFRU5fTElORVMsIGRvdWJsZWxpbmUuZ2V0TWVhc3VyZWRIZWlnaHQoKSkqcGFyYW1zLmRlZ3JlZXMyUGl4ZWxzKEFOR0xFX0JFVFdFRU5fTElORVMvMik7XG5cbiAgbG93ZXJUZXh0LnRleHQgPSAxMCogTWF0aC5mbG9vcigteS8xMCk7XG4gIGxvd2VyVGV4dC50cmFuc2xhdGVYID0gTWF0aC5zaW4oeiAqIE1hdGguUEkvMTgwKSogKGRpc3RhbmNlRnJvbUNlbnRlciArIGRpc3QpO1xuICBsb3dlclRleHQudHJhbnNsYXRlWSA9IE1hdGguY29zKHogKiBNYXRoLlBJLzE4MCkqIChkaXN0YW5jZUZyb21DZW50ZXIgKyBkaXN0KSArIHlUcmFuc2xhdGU7XG4gIGxvd2VyVGV4dC5yb3RhdGUgPSAtejtcblxuICB1cHBlclRleHQudGV4dCA9IDEwKiBNYXRoLmZsb29yKCgteSArIDEwKS8xMCk7XG4gIHVwcGVyVGV4dC50cmFuc2xhdGVYID0gTWF0aC5zaW4oeiAqIE1hdGguUEkvMTgwKSogKGRpc3RhbmNlRnJvbUNlbnRlciAtIGRpc3QpO1xuICB1cHBlclRleHQudHJhbnNsYXRlWSA9IE1hdGguY29zKHogKiBNYXRoLlBJLzE4MCkqIChkaXN0YW5jZUZyb21DZW50ZXIgLSBkaXN0KSArIHlUcmFuc2xhdGU7XG4gIHVwcGVyVGV4dC5yb3RhdGUgPSAtejtcbn07XHJcblxyXG5jb25zdCByb3RhdGlvbkNhbGxiYWNrID0gZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgLy9jb25zb2xlLmxvZyhcIng6IFwiICsgZGF0YS54ICsgXCIgeTogXCIgKyBkYXRhLnkgKyBcIiB6OiBcIiArIGRhdGEueik7XHJcbiAgICB4ID0gZGF0YS54O1xyXG4gICAgeSA9IGRhdGEueTtcclxuICAgIHogPSBkYXRhLno7XHJcbiAgICBpZihhcHAuaW9zKSB1cGRhdGVDYWxsYmFjazIoKTsgLy8gaW9zIGRvZXNuJ3Qgc2VlbSB0byBleHBvc2UgYSBjYWxsYmFjayBmb3IgZXZlcnkgZnJhbWUgdXBkYXRlIGluIHRoZSBjYW1lcmEgcHJldmlldzsgdGhlcmVmb3JlLCB3ZSdsbCBob3Agb24gdGhlIHJvdGF0aW9uIGNhbGxiYWNrXHJcbn07XHJcblxyXG4vLyBleHBvcnQgZnVuY3Rpb24gc2hvd1NpZGVEcmF3ZXIoYXJnczogRXZlbnREYXRhKSB7XHJcbi8vICAgICBjb25zb2xlLmxvZyhcIlNob3cgU2lkZURyYXdlciB0YXBwZWQuXCIpO1xyXG4vLyB9XHJcblxyXG4vL1RPRE86IHNwbGl0IHVwIHRoZSBjb2RlXHJcbmV4cG9ydCBmdW5jdGlvbiBvbkxvYWRlZChhcmdzOiBFdmVudERhdGEpIHtcclxuICBvcmllbnRhdGlvbi5zZXRDdXJyZW50T3JpZW50YXRpb24oXCJwb3J0cmFpdFwiLCAoKSA9PiB7fSk7XHJcbiAgaWYgKGFwcC5hbmRyb2lkICYmIHBsYXRmb3JtLmRldmljZS5zZGtWZXJzaW9uID49ICcyMScpIHtcclxuICAgICAgY29uc3QgVmlldyA6YW55ID0gYW5kcm9pZC52aWV3LlZpZXc7XHJcbiAgICAgIGNvbnN0IHdpbmRvdyA9IGFwcC5hbmRyb2lkLnN0YXJ0QWN0aXZpdHkuZ2V0V2luZG93KCk7XHJcbiAgICAgIC8vIHNldCB0aGUgc3RhdHVzIGJhciB0byBDb2xvci5UcmFuc3BhcmVudFxyXG4gICAgICAvLyB3aW5kb3cuc2V0U3RhdHVzQmFyQ29sb3IoMHgwMDAwMDApO1xyXG4gICAgICBjb25zdCBkZWNvclZpZXcgPSB3aW5kb3cuZ2V0RGVjb3JWaWV3KCk7XHJcbiAgICAgIGRlY29yVmlldy5zZXRTeXN0ZW1VaVZpc2liaWxpdHkoXHJcbiAgICAgICAgICBWaWV3LlNZU1RFTV9VSV9GTEFHX0xBWU9VVF9TVEFCTEVcclxuICAgICAgICAgIHwgVmlldy5TWVNURU1fVUlfRkxBR19MQVlPVVRfSElERV9OQVZJR0FUSU9OXHJcbiAgICAgICAgICB8IFZpZXcuU1lTVEVNX1VJX0ZMQUdfTEFZT1VUX0ZVTExTQ1JFRU5cclxuICAgICAgICAgIHwgVmlldy5TWVNURU1fVUlfRkxBR19ISURFX05BVklHQVRJT04gLy8gaGlkZSBuYXYgYmFyXHJcbiAgICAgICAgICB8IFZpZXcuU1lTVEVNX1VJX0ZMQUdfRlVMTFNDUkVFTiAvLyBoaWRlIHN0YXR1cyBiYXJcclxuICAgICAgICAgIHwgVmlldy5TWVNURU1fVUlfRkxBR19JTU1FUlNJVkVfU1RJQ0tZKTtcclxuICB9XHJcbiAgY2FtZXJhUHJldmlldy5vbkxvYWRlZChhcmdzLCBcInBsYWNlaG9sZGVyLXZpZXdcIik7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvbkNyZWF0aW5nVmlldyhhcmdzOiBFdmVudERhdGEpIHtcclxuICBjaGFydHMuaW5pdEdyYXBoKHBhZ2UpO1xyXG4gIGlmKGFwcC5hbmRyb2lkKSB7XHJcbiAgICBwZXJtaXNzaW9ucy5yZXF1ZXN0UGVybWlzc2lvbihhbmRyb2lkW1wiTWFuaWZlc3RcIl0ucGVybWlzc2lvbi5DQU1FUkEsIFwiSSBuZWVkIHRoZXNlIHBlcm1pc3Npb25zIGZvciB0aGUgdmlld2ZpbmRlclwiKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICBjb25zb2xlLmxvZyhcIldvbyBIb28sIEkgaGF2ZSB0aGUgcG93ZXIhXCIpO1xyXG4gICAgfSlcclxuICAgIC5jYXRjaChmdW5jdGlvbigpIHtcclxuICAgICAgIGNvbnNvbGUubG9nKFwiVWggb2gsIG5vIHBlcm1pc3Npb25zIC0gcGxhbiBCIHRpbWUhXCIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGlmKGFwcC5hbmRyb2lkKSBwYXJhbXMuaW5pdGlhbGl6ZSgpO1xyXG4gIGNhbWVyYVByZXZpZXcub25DcmVhdGluZ1ZpZXcodXBkYXRlQ2FsbGJhY2syLCBhcmdzKTtcclxuICBpZiAoYXBwLmlvcyAhPT0gdW5kZWZpbmVkKSBwYXJhbXMuaW5pdGlhbGl6ZSgpO1xyXG4gIHJvdFZlY3Rvci5zdGFydFJvdFVwZGF0ZXMocm90YXRpb25DYWxsYmFjaywgIHsgc2Vuc29yRGVsYXk6IFwiZ2FtZVwiIH0pO1xyXG4gIGNvbnN0IG1heFNpemUgPSBjYW1lcmFQcmV2aWV3LmdldE1heFNpemUoKTtcclxuICBwYXJhbXMuc2V0VmFycyhtYXhTaXplWzBdLCBtYXhTaXplWzFdKTtcclxuICAvLyBjb25zb2xlLmxvZyhwYXJhbXMuZ2V0VmVydGljYWxGT1YoKSArIFwiIFwiICsgcGFyYW1zLmdldEhvcml6b250YWxGT1YoKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvblRha2VTaG90KGFyZ3M6IEV2ZW50RGF0YSkge1xyXG4gIGNhbWVyYVByZXZpZXcub25UYWtlU2hvdChhcmdzKTtcclxuICBpc09uID0gIWlzT247XHJcblxyXG4gIGNhcHR1cmVidG4uYW5pbWF0ZSh7XHJcbiAgICBzY2FsZTogeyB4OiAxLjIsIHk6IDEuMiB9LFxyXG4gICAgZHVyYXRpb246IDEwMFxyXG4gIH0pLnRoZW4oKCk9PiB7XHJcbiAgICBjYXB0dXJlYnRuLmFuaW1hdGUoXHJcbiAgICAgIHtcclxuICAgICAgICBzY2FsZTogeyB4OiAxLCB5OiAxfSxcclxuICAgICAgICBkdXJhdGlvbjogMzAwLFxyXG4gICAgICAgIGN1cnZlOiBBbmltYXRpb25DdXJ2ZS5zcHJpbmdcclxuICAgICAgfVxyXG4gICAgKTtcclxuICAgIHJlY29yZHN0b3Auc3JjID0gaXNPbj8gXCJyZXM6Ly9zdG9wXCIgOiBcInJlczovL3JlY29yZFwiO1xyXG4gIH0pO1xyXG4gIGNvbnNvbGUubG9nKFwiZWw6IFwiICsgeSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBuYXZpZ2F0aW5nVG8oYXJnczogRXZlbnREYXRhKSB7XHJcbiAgICBwYWdlID0gPFBhZ2U+YXJncy5vYmplY3Q7XHJcbiAgICBjcm9zc2hhaXIgPSBwYWdlLmdldFZpZXdCeUlkKFwiY3Jvc3NoYWlyXCIpO1xyXG4gICAgZG91YmxlbGluZSA9IHBhZ2UuZ2V0Vmlld0J5SWQoXCJkb3VibGVsaW5lXCIpO1xyXG4gICAgdXBwZXJUZXh0ID0gcGFnZS5nZXRWaWV3QnlJZChcInVwcGVyVGV4dFwiKTtcclxuICAgIGxvd2VyVGV4dCA9IHBhZ2UuZ2V0Vmlld0J5SWQoXCJsb3dlclRleHRcIik7XHJcbiAgICBjYXB0dXJlYnRuID0gcGFnZS5nZXRWaWV3QnlJZChcImNhcHR1cmVidG5cIik7XHJcbiAgICByZWNvcmRzdG9wID0gcGFnZS5nZXRWaWV3QnlJZChcInJlY29yZHN0b3BcIik7XHJcbn1cclxuXHJcbmFwcC5vbihhcHAucmVzdW1lRXZlbnQsIGZ1bmN0aW9uKGFyZ3MpIHtcclxuICByb3RWZWN0b3Iuc3RhcnRSb3RVcGRhdGVzKHJvdGF0aW9uQ2FsbGJhY2ssICB7IHNlbnNvckRlbGF5OiBcImdhbWVcIiB9KTtcclxuICBjYW1lcmFQcmV2aWV3Lm9uUmVzdW1lKCk7XHJcbn0pO1xyXG5hcHAub24oYXBwLnN1c3BlbmRFdmVudCwgZnVuY3Rpb24oYXJncykge1xyXG4gIGNhbWVyYVByZXZpZXcub25QYXVzZSgpO1xyXG4gIHJvdFZlY3Rvci5zdG9wUm90VXBkYXRlcygpO1xyXG4gIGNoYXJ0cy5vbkV4aXQoKTtcclxufSk7XHJcbmFwcC5vbihhcHAuZXhpdEV2ZW50LCBmdW5jdGlvbihhcmdzKSB7XHJcbiAgY29uc29sZS5sb2coXCJPbiBFeGl0dGluZ1wiKTtcclxuICByb3RWZWN0b3Iuc3RvcFJvdFVwZGF0ZXMoKTtcclxufSk7XHJcbiJdfQ==