/*
In NativeScript, a file with the same name as an XML file is known as
a code-behind file. The code-behind is a great place to place your view
logic, and to set up your pageâ€™s data binding.
*/
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var cameraPreview = require("./nativescript-camera-preview/nativescript-camera-preview");
var rotVector = require("./nativescript-rotation-vector/index");
var app = require("application");
var platform = require("platform");
var orientation = require("nativescript-screen-orientation");
var params = require("./nativescript-fov/nativescript-fov");
var permissions = require("nativescript-permissions");
var crosshair;
var doubleline;
var upperText;
var lowerText;
var x, y, z;
var measuredWidth;
var page;
var OUTER_CIRCLE_DIAMETER = 2;
var ANGLE_BETWEEN_LINES = 10;
var updateCallback = function () {
    // console.log("Entered updateCallback");
    var yTranslate = app.ios ? -20 : 0;
    var scaleCrosshair = params.degrees2Scale(OUTER_CIRCLE_DIAMETER, crosshair.getMeasuredHeight());
    crosshair.animate({
        scale: {
            x: scaleCrosshair,
            y: scaleCrosshair
        },
        translate: {
            x: 0,
            y: yTranslate
        },
        rotate: -z,
        duration: 0
    });
    var scaleDoubleLine = params.degrees2Scale(ANGLE_BETWEEN_LINES, doubleline.getMeasuredHeight());
    var distanceFromCenter = params.pixels2Dp((params.degrees2Pixels((-y % ANGLE_BETWEEN_LINES)
        - ANGLE_BETWEEN_LINES / 2 * (y > 0 ? -1 : 1))));
    lowerText.text = 10 * Math.floor(-y / 10);
    upperText.text = 10 * Math.floor((-y + 10) / 10);
    doubleline.animate({
        scale: {
            x: scaleDoubleLine,
            y: scaleDoubleLine
        },
        translate: {
            x: Math.sin(z * Math.PI / 180) * distanceFromCenter,
            y: Math.cos(z * Math.PI / 180) * distanceFromCenter + yTranslate
        },
        rotate: -z,
        duration: 0
    });
    lowerText.animate({
        translate: {
            x: Math.sin(z * Math.PI / 180) * (distanceFromCenter + scaleDoubleLine * params.degrees2Pixels(ANGLE_BETWEEN_LINES / 2)),
            y: Math.cos(z * Math.PI / 180) * (distanceFromCenter + scaleDoubleLine * params.degrees2Pixels(ANGLE_BETWEEN_LINES / 2)) + yTranslate
        },
        rotate: -z,
        duration: 0
    });
    upperText.animate({
        translate: {
            x: Math.sin(z * Math.PI / 180) * (distanceFromCenter - scaleDoubleLine * params.degrees2Pixels(ANGLE_BETWEEN_LINES / 2)),
            y: Math.cos(z * Math.PI / 180) * (distanceFromCenter - scaleDoubleLine * params.degrees2Pixels(ANGLE_BETWEEN_LINES / 2)) + yTranslate
        },
        rotate: -z,
        duration: 0
    });
    if (app.ios) {
        var cameraView = page.getViewById("placeholder-view");
        cameraView.animate({
            scale: {
                x: platform.screen.mainScreen.heightPixels / cameraView.getMeasuredHeight(),
                y: platform.screen.mainScreen.heightPixels / cameraView.getMeasuredHeight()
            },
            translate: {
                x: 0,
                y: app.ios ? -10 : 0
            },
            duration: 2000
        });
    }
};
var rotationCallback = function (data) {
    //console.log("x: " + data.x + " y: " + data.y + " z: " + data.z);
    x = data.x;
    y = data.y;
    z = data.z;
    if (app.ios)
        updateCallback(); // ios doesn't seem to expose a callback for every frame update in the camera preview; therefore, we'll hop on the rotation callback
};
// export function showSideDrawer(args: EventData) {
//     console.log("Show SideDrawer tapped.");
// }
//TODO: split up the code
function onLoaded(args) {
    orientation.setCurrentOrientation("portrait", function () { });
    if (app.android && platform.device.sdkVersion >= '21') {
        var View = android.view.View;
        var window_1 = app.android.startActivity.getWindow();
        // set the status bar to Color.Transparent
        // window.setStatusBarColor(0x000000);
        var decorView = window_1.getDecorView();
        decorView.setSystemUiVisibility(View.SYSTEM_UI_FLAG_LAYOUT_STABLE
            | View.SYSTEM_UI_FLAG_LAYOUT_HIDE_NAVIGATION
            | View.SYSTEM_UI_FLAG_LAYOUT_FULLSCREEN
            | View.SYSTEM_UI_FLAG_HIDE_NAVIGATION // hide nav bar
            | View.SYSTEM_UI_FLAG_FULLSCREEN // hide status bar
            | View.SYSTEM_UI_FLAG_IMMERSIVE_STICKY);
    }
    cameraPreview.onLoaded(args, "placeholder-view");
}
exports.onLoaded = onLoaded;
function onCreatingView(args) {
    if (app.android) {
        permissions.requestPermission(android["Manifest"].permission.CAMERA, "I need these permissions for the viewfinder")
            .then(function () {
            console.log("Woo Hoo, I have the power!");
        })
            .catch(function () {
            console.log("Uh oh, no permissions - plan B time!");
        });
    }
    if (app.android)
        params.initialize();
    cameraPreview.onCreatingView(updateCallback, args);
    if (app.ios !== undefined)
        params.initialize();
    rotVector.startRotUpdates(rotationCallback, { sensorDelay: "game" });
    var maxSize = cameraPreview.getMaxSize();
    params.setVars(maxSize[0], maxSize[1]);
    measuredWidth = params.degrees2Pixels(OUTER_CIRCLE_DIAMETER);
    // console.log(params.getVerticalFOV() + " " + params.getHorizontalFOV());
}
exports.onCreatingView = onCreatingView;
function onTakeShot(args) {
    cameraPreview.onTakeShot(args);
    console.log("el: " + y);
}
exports.onTakeShot = onTakeShot;
function navigatingTo(args) {
    page = args.object;
    crosshair = page.getViewById("crosshair");
    doubleline = page.getViewById("doubleline");
    upperText = page.getViewById("upperText");
    lowerText = page.getViewById("lowerText");
}
exports.navigatingTo = navigatingTo;
app.on(app.resumeEvent, function (args) {
    rotVector.startRotUpdates(rotationCallback, { sensorDelay: "game" });
    cameraPreview.onResume();
});
app.on(app.suspendEvent, function (args) {
    cameraPreview.onPause();
    rotVector.stopRotUpdates();
});
app.on(app.exitEvent, function (args) {
    rotVector.stopRotUpdates();
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFpbi1wYWdlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibWFpbi1wYWdlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0VBSUU7OztBQUlGLHlGQUEyRjtBQUMzRixnRUFBa0U7QUFDbEUsaUNBQW1DO0FBR25DLG1DQUFxQztBQUNyQyw2REFBK0Q7QUFDL0QsNERBQThEO0FBQzlELHNEQUF3RDtBQUV4RCxJQUFJLFNBQWMsQ0FBQztBQUNuQixJQUFJLFVBQWUsQ0FBQztBQUNwQixJQUFJLFNBQWMsQ0FBQztBQUNuQixJQUFJLFNBQWMsQ0FBQztBQUNuQixJQUFJLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ1osSUFBSSxhQUFhLENBQUM7QUFDbEIsSUFBSSxJQUFJLENBQUM7QUFFVCxJQUFNLHFCQUFxQixHQUFHLENBQUMsQ0FBQztBQUNoQyxJQUFNLG1CQUFtQixHQUFHLEVBQUUsQ0FBQztBQUUvQixJQUFNLGNBQWMsR0FBRztJQUNyQix5Q0FBeUM7SUFDekMsSUFBTSxVQUFVLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRSxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7SUFDcEMsSUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxxQkFBcUIsRUFBRSxTQUFTLENBQUMsaUJBQWlCLEVBQUUsQ0FBQyxDQUFDO0lBQ2xHLFNBQVMsQ0FBQyxPQUFPLENBQUM7UUFDaEIsS0FBSyxFQUFFO1lBQ0wsQ0FBQyxFQUFFLGNBQWM7WUFDakIsQ0FBQyxFQUFFLGNBQWM7U0FDbEI7UUFDRCxTQUFTLEVBQUU7WUFDVCxDQUFDLEVBQUUsQ0FBQztZQUNKLENBQUMsRUFBRSxVQUFVO1NBQ2Q7UUFDRCxNQUFNLEVBQUUsQ0FBQyxDQUFDO1FBQ1YsUUFBUSxFQUFFLENBQUM7S0FDWixDQUFDLENBQUM7SUFFSCxJQUFNLGVBQWUsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLG1CQUFtQixFQUFFLFVBQVUsQ0FBQyxpQkFBaUIs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QUMsY0FBYyxFQUFFLENBQUM7QUFDN0IsQ0FBQyxDQUFDLENBQUM7QUFDSCxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsVUFBUyxJQUFJO0lBQ2pDLFNBQVMsQ0FBQyxjQUFjLEVBQUUsQ0FBQztBQUM3QixDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qXHJcbkluIE5hdGl2ZVNjcmlwdCwgYSBmaWxlIHdpdGggdGhlIHNhbWUgbmFtZSBhcyBhbiBYTUwgZmlsZSBpcyBrbm93biBhc1xyXG5hIGNvZGUtYmVoaW5kIGZpbGUuIFRoZSBjb2RlLWJlaGluZCBpcyBhIGdyZWF0IHBsYWNlIHRvIHBsYWNlIHlvdXIgdmlld1xyXG5sb2dpYywgYW5kIHRvIHNldCB1cCB5b3VyIHBhZ2XigJlzIGRhdGEgYmluZGluZy5cclxuKi9cclxuXHJcbmltcG9ydCB7IEV2ZW50RGF0YSB9IGZyb20gJ2RhdGEvb2JzZXJ2YWJsZSc7XHJcbmltcG9ydCB7IFBhZ2UgfSBmcm9tICd1aS9wYWdlJztcclxuaW1wb3J0ICogYXMgY2FtZXJhUHJldmlldyBmcm9tICcuL25hdGl2ZXNjcmlwdC1jYW1lcmEtcHJldmlldy9uYXRpdmVzY3JpcHQtY2FtZXJhLXByZXZpZXcnO1xyXG5pbXBvcnQgKiBhcyByb3RWZWN0b3IgZnJvbSBcIi4vbmF0aXZlc2NyaXB0LXJvdGF0aW9uLXZlY3Rvci9pbmRleFwiO1xyXG5pbXBvcnQgKiBhcyBhcHAgZnJvbSBcImFwcGxpY2F0aW9uXCI7XHJcbmltcG9ydCAqIGFzIGZyYW1lTW9kdWxlIGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL3VpL2ZyYW1lXCI7XHJcbmltcG9ydCAqIGFzIGFuaW1hdGlvbiBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy91aS9hbmltYXRpb25cIjtcclxuaW1wb3J0ICogYXMgcGxhdGZvcm0gZnJvbSBcInBsYXRmb3JtXCI7XHJcbmltcG9ydCAqIGFzIG9yaWVudGF0aW9uIGZyb20gXCJuYXRpdmVzY3JpcHQtc2NyZWVuLW9yaWVudGF0aW9uXCI7XHJcbmltcG9ydCAqIGFzIHBhcmFtcyBmcm9tIFwiLi9uYXRpdmVzY3JpcHQtZm92L25hdGl2ZXNjcmlwdC1mb3ZcIjtcclxuaW1wb3J0ICogYXMgcGVybWlzc2lvbnMgZnJvbSBcIm5hdGl2ZXNjcmlwdC1wZXJtaXNzaW9uc1wiO1xyXG5cclxubGV0IGNyb3NzaGFpciA6YW55O1xyXG5sZXQgZG91YmxlbGluZSA6YW55O1xyXG5sZXQgdXBwZXJUZXh0IDphbnk7XHJcbmxldCBsb3dlclRleHQgOmFueTtcclxubGV0IHgsIHksIHo7XHJcbmxldCBtZWFzdXJlZFdpZHRoO1xyXG5sZXQgcGFnZTtcclxuXHJcbmNvbnN0IE9VVEVSX0NJUkNMRV9ESUFNRVRFUiA9IDI7XHJcbmNvbnN0IEFOR0xFX0JFVFdFRU5fTElORVMgPSAxMDtcclxuXHJcbmNvbnN0IHVwZGF0ZUNhbGxiYWNrID0gZnVuY3Rpb24oKSB7XHJcbiAgLy8gY29uc29sZS5sb2coXCJFbnRlcmVkIHVwZGF0ZUNhbGxiYWNrXCIpO1xyXG4gIGNvbnN0IHlUcmFuc2xhdGUgPSBhcHAuaW9zPyAtMjAgOiAwO1xyXG4gIGNvbnN0IHNjYWxlQ3Jvc3NoYWlyID0gcGFyYW1zLmRlZ3JlZXMyU2NhbGUoT1VURVJfQ0lSQ0xFX0RJQU1FVEVSLCBjcm9zc2hhaXIuZ2V0TWVhc3VyZWRIZWlnaHQoKSk7XHJcbiAgY3Jvc3NoYWlyLmFuaW1hdGUoe1xyXG4gICAgc2NhbGU6IHtcclxuICAgICAgeDogc2NhbGVDcm9zc2hhaXIsXHJcbiAgICAgIHk6IHNjYWxlQ3Jvc3NoYWlyXHJcbiAgICB9LFxyXG4gICAgdHJhbnNsYXRlOiB7XHJcbiAgICAgIHg6IDAsXHJcbiAgICAgIHk6IHlUcmFuc2xhdGVcclxuICAgIH0sXHJcbiAgICByb3RhdGU6IC16LFxyXG4gICAgZHVyYXRpb246IDBcclxuICB9KTtcclxuXHJcbiAgY29uc3Qgc2NhbGVEb3VibGVMaW5lID0gcGFyYW1zLmRlZ3JlZXMyU2NhbGUoQU5HTEVfQkVUV0VFTl9MSU5FUywgZG91YmxlbGluZS5nZXRNZWFzdXJlZEhlaWdodCgpKTtcclxuICBjb25zdCBkaXN0YW5jZUZyb21DZW50ZXIgPSBwYXJhbXMucGl4ZWxzMkRwKChwYXJhbXMuZGVncmVlczJQaXhlbHMoKC15ICUgQU5HTEVfQkVUV0VFTl9MSU5FUylcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0gQU5HTEVfQkVUV0VFTl9MSU5FUy8yICogKHk+MD8gLTE6IDEpKSkpO1xyXG4gIGxvd2VyVGV4dC50ZXh0ID0gMTAqIE1hdGguZmxvb3IoLXkvMTApO1xyXG4gIHVwcGVyVGV4dC50ZXh0ID0gMTAqIE1hdGguZmxvb3IoKC15KzEwKS8xMCk7XHJcbiAgZG91YmxlbGluZS5hbmltYXRlKHtcclxuICAgIHNjYWxlOiB7XHJcbiAgICAgIHg6IHNjYWxlRG91YmxlTGluZSxcclxuICAgICAgeTogc2NhbGVEb3VibGVMaW5lXHJcbiAgICB9LFxyXG4gICAgdHJhbnNsYXRlOiB7XHJcbiAgICAgIHggOiBNYXRoLnNpbih6Kk1hdGguUEkvMTgwKSpkaXN0YW5jZUZyb21DZW50ZXIsXHJcbiAgICAgIHk6IE1hdGguY29zKHoqTWF0aC5QSS8xODApKmRpc3RhbmNlRnJvbUNlbnRlciArIHlUcmFuc2xhdGVcclxuICAgIH0sXHJcblxyXG4gICAgcm90YXRlOiAteixcclxuICAgIGR1cmF0aW9uOiAwXHJcbiAgfSk7XHJcbiAgbG93ZXJUZXh0LmFuaW1hdGUoe1xyXG4gICAgdHJhbnNsYXRlOiB7XHJcbiAgICAgIHggOiBNYXRoLnNpbih6Kk1hdGguUEkvMTgwKSogKGRpc3RhbmNlRnJvbUNlbnRlcitzY2FsZURvdWJsZUxpbmUqcGFyYW1zLmRlZ3JlZXMyUGl4ZWxzKEFOR0xFX0JFVFdFRU5fTElORVMvMikpLFxyXG4gICAgICB5IDogTWF0aC5jb3MoeipNYXRoLlBJLzE4MCkqIChkaXN0YW5jZUZyb21DZW50ZXIrc2NhbGVEb3VibGVMaW5lKnBhcmFtcy5kZWdyZWVzMlBpeGVscyhBTkdMRV9CRVRXRUVOX0xJTkVTLzIpKSArIHlUcmFuc2xhdGVcclxuICAgIH0sXHJcbiAgICByb3RhdGU6IC16LFxyXG4gICAgZHVyYXRpb246IDBcclxuICB9KTtcclxuICB1cHBlclRleHQuYW5pbWF0ZSh7XHJcbiAgICB0cmFuc2xhdGU6IHtcclxuICAgICAgeCA6ICBNYXRoLnNpbih6Kk1hdGguUEkvMTgwKSogKGRpc3RhbmNlRnJvbUNlbnRlci1zY2FsZURvdWJsZUxpbmUqcGFyYW1zLmRlZ3JlZXMyUGl4ZWxzKEFOR0xFX0JFVFdFRU5fTElORVMvMikpLFxyXG4gICAgICB5IDogIE1hdGguY29zKHoqTWF0aC5QSS8xODApKiAoZGlzdGFuY2VGcm9tQ2VudGVyLXNjYWxlRG91YmxlTGluZSpwYXJhbXMuZGVncmVlczJQaXhlbHMoQU5HTEVfQkVUV0VFTl9MSU5FUy8yKSkgKyB5VHJhbnNsYXRlXHJcbiAgICB9LFxyXG4gICAgcm90YXRlOiAteixcclxuICAgIGR1cmF0aW9uOiAwXHJcbiAgfSk7XHJcbiAgaWYgKGFwcC5pb3MpIHtcclxuICAgIGxldCBjYW1lcmFWaWV3ID0gcGFnZS5nZXRWaWV3QnlJZChcInBsYWNlaG9sZGVyLXZpZXdcIik7XHJcbiAgICBjYW1lcmFWaWV3LmFuaW1hdGUoe1xyXG4gICAgICBzY2FsZToge1xyXG4gICAgICAgIHg6IHBsYXRmb3JtLnNjcmVlbi5tYWluU2NyZWVuLmhlaWdodFBpeGVscy9jYW1lcmFWaWV3LmdldE1lYXN1cmVkSGVpZ2h0KCksXHJcbiAgICAgICAgeTogcGxhdGZvcm0uc2NyZWVuLm1haW5TY3JlZW4uaGVpZ2h0UGl4ZWxzL2NhbWVyYVZpZXcuZ2V0TWVhc3VyZWRIZWlnaHQoKVxyXG4gICAgICB9LFxyXG4gICAgICB0cmFuc2xhdGU6IHtcclxuICAgICAgICB4OiAwLFxyXG4gICAgICAgIHk6IGFwcC5pb3M/IC0xMCA6IDBcclxuICAgICAgfSxcclxuICAgICAgZHVyYXRpb246IDIwMDBcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbn07XHJcblxyXG5jb25zdCByb3RhdGlvbkNhbGxiYWNrID0gZnVuY3Rpb24oZGF0YSkge1xyXG4gICAgLy9jb25zb2xlLmxvZyhcIng6IFwiICsgZGF0YS54ICsgXCIgeTogXCIgKyBkYXRhLnkgKyBcIiB6OiBcIiArIGRhdGEueik7XHJcbiAgICB4ID0gZGF0YS54O1xyXG4gICAgeSA9IGRhdGEueTtcclxuICAgIHogPSBkYXRhLno7XHJcbiAgICBpZihhcHAuaW9zKSB1cGRhdGVDYWxsYmFjaygpOyAvLyBpb3MgZG9lc24ndCBzZWVtIHRvIGV4cG9zZSBhIGNhbGxiYWNrIGZvciBldmVyeSBmcmFtZSB1cGRhdGUgaW4gdGhlIGNhbWVyYSBwcmV2aWV3OyB0aGVyZWZvcmUsIHdlJ2xsIGhvcCBvbiB0aGUgcm90YXRpb24gY2FsbGJhY2tcclxufTtcclxuXHJcbi8vIGV4cG9ydCBmdW5jdGlvbiBzaG93U2lkZURyYXdlcihhcmdzOiBFdmVudERhdGEpIHtcclxuLy8gICAgIGNvbnNvbGUubG9nKFwiU2hvdyBTaWRlRHJhd2VyIHRhcHBlZC5cIik7XHJcbi8vIH1cclxuXHJcbi8vVE9ETzogc3BsaXQgdXAgdGhlIGNvZGVcclxuZXhwb3J0IGZ1bmN0aW9uIG9uTG9hZGVkKGFyZ3M6IEV2ZW50RGF0YSkge1xyXG4gIG9yaWVudGF0aW9uLnNldEN1cnJlbnRPcmllbnRhdGlvbihcInBvcnRyYWl0XCIsICgpID0+IHt9KTtcclxuICBpZiAoYXBwLmFuZHJvaWQgJiYgcGxhdGZvcm0uZGV2aWNlLnNka1ZlcnNpb24gPj0gJzIxJykge1xyXG4gICAgICBjb25zdCBWaWV3IDphbnkgPSBhbmRyb2lkLnZpZXcuVmlldztcclxuICAgICAgY29uc3Qgd2luZG93ID0gYXBwLmFuZHJvaWQuc3RhcnRBY3Rpdml0eS5nZXRXaW5kb3coKTtcclxuICAgICAgLy8gc2V0IHRoZSBzdGF0dXMgYmFyIHRvIENvbG9yLlRyYW5zcGFyZW50XHJcbiAgICAgIC8vIHdpbmRvdy5zZXRTdGF0dXNCYXJDb2xvcigweDAwMDAwMCk7XHJcbiAgICAgIGNvbnN0IGRlY29yVmlldyA9IHdpbmRvdy5nZXREZWNvclZpZXcoKTtcclxuICAgICAgZGVjb3JWaWV3LnNldFN5c3RlbVVpVmlzaWJpbGl0eShcclxuICAgICAgICAgIFZpZXcuU1lTVEVNX1VJX0ZMQUdfTEFZT1VUX1NUQUJMRVxyXG4gICAgICAgICAgfCBWaWV3LlNZU1RFTV9VSV9GTEFHX0xBWU9VVF9ISURFX05BVklHQVRJT05cclxuICAgICAgICAgIHwgVmlldy5TWVNURU1fVUlfRkxBR19MQVlPVVRfRlVMTFNDUkVFTlxyXG4gICAgICAgICAgfCBWaWV3LlNZU1RFTV9VSV9GTEFHX0hJREVfTkFWSUdBVElPTiAvLyBoaWRlIG5hdiBiYXJcclxuICAgICAgICAgIHwgVmlldy5TWVNURU1fVUlfRkxBR19GVUxMU0NSRUVOIC8vIGhpZGUgc3RhdHVzIGJhclxyXG4gICAgICAgICAgfCBWaWV3LlNZU1RFTV9VSV9GTEFHX0lNTUVSU0lWRV9TVElDS1kpO1xyXG4gIH1cclxuICBjYW1lcmFQcmV2aWV3Lm9uTG9hZGVkKGFyZ3MsIFwicGxhY2Vob2xkZXItdmlld1wiKTtcclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIG9uQ3JlYXRpbmdWaWV3KGFyZ3M6IEV2ZW50RGF0YSkge1xyXG4gIGlmKGFwcC5hbmRyb2lkKSB7XHJcbiAgICBwZXJtaXNzaW9ucy5yZXF1ZXN0UGVybWlzc2lvbihhbmRyb2lkW1wiTWFuaWZlc3RcIl0ucGVybWlzc2lvbi5DQU1FUkEsIFwiSSBuZWVkIHRoZXNlIHBlcm1pc3Npb25zIGZvciB0aGUgdmlld2ZpbmRlclwiKVxyXG4gICAgLnRoZW4oZnVuY3Rpb24oKSB7XHJcbiAgICAgICBjb25zb2xlLmxvZyhcIldvbyBIb28sIEkgaGF2ZSB0aGUgcG93ZXIhXCIpO1xyXG4gICAgfSlcclxuICAgIC5jYXRjaChmdW5jdGlvbigpIHtcclxuICAgICAgIGNvbnNvbGUubG9nKFwiVWggb2gsIG5vIHBlcm1pc3Npb25zIC0gcGxhbiBCIHRpbWUhXCIpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIGlmKGFwcC5hbmRyb2lkKSBwYXJhbXMuaW5pdGlhbGl6ZSgpO1xyXG4gIGNhbWVyYVByZXZpZXcub25DcmVhdGluZ1ZpZXcodXBkYXRlQ2FsbGJhY2ssIGFyZ3MpO1xyXG4gIGlmIChhcHAuaW9zICE9PSB1bmRlZmluZWQpIHBhcmFtcy5pbml0aWFsaXplKCk7XHJcbiAgcm90VmVjdG9yLnN0YXJ0Um90VXBkYXRlcyhyb3RhdGlvbkNhbGxiYWNrLCAgeyBzZW5zb3JEZWxheTogXCJnYW1lXCIgfSk7XHJcbiAgY29uc3QgbWF4U2l6ZSA9IGNhbWVyYVByZXZpZXcuZ2V0TWF4U2l6ZSgpO1xyXG4gIHBhcmFtcy5zZXRWYXJzKG1heFNpemVbMF0sIG1heFNpemVbMV0pO1xyXG4gIG1lYXN1cmVkV2lkdGggPSBwYXJhbXMuZGVncmVlczJQaXhlbHMoT1VURVJfQ0lSQ0xFX0RJQU1FVEVSKTtcclxuICAvLyBjb25zb2xlLmxvZyhwYXJhbXMuZ2V0VmVydGljYWxGT1YoKSArIFwiIFwiICsgcGFyYW1zLmdldEhvcml6b250YWxGT1YoKSk7XHJcbn1cclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBvblRha2VTaG90KGFyZ3M6IEV2ZW50RGF0YSkge1xyXG4gIGNhbWVyYVByZXZpZXcub25UYWtlU2hvdChhcmdzKTtcclxuICBjb25zb2xlLmxvZyhcImVsOiBcIiArIHkpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gbmF2aWdhdGluZ1RvKGFyZ3M6IEV2ZW50RGF0YSkge1xyXG4gICAgcGFnZSA9IDxQYWdlPmFyZ3Mub2JqZWN0O1xyXG4gICAgY3Jvc3NoYWlyID0gcGFnZS5nZXRWaWV3QnlJZChcImNyb3NzaGFpclwiKTtcclxuICAgIGRvdWJsZWxpbmUgPSBwYWdlLmdldFZpZXdCeUlkKFwiZG91YmxlbGluZVwiKTtcclxuICAgIHVwcGVyVGV4dCA9IHBhZ2UuZ2V0Vmlld0J5SWQoXCJ1cHBlclRleHRcIik7XHJcbiAgICBsb3dlclRleHQgPSBwYWdlLmdldFZpZXdCeUlkKFwibG93ZXJUZXh0XCIpO1xyXG59XHJcblxyXG5hcHAub24oYXBwLnJlc3VtZUV2ZW50LCBmdW5jdGlvbihhcmdzKSB7XHJcbiAgcm90VmVjdG9yLnN0YXJ0Um90VXBkYXRlcyhyb3RhdGlvbkNhbGxiYWNrLCAgeyBzZW5zb3JEZWxheTogXCJnYW1lXCIgfSk7XHJcbiAgY2FtZXJhUHJldmlldy5vblJlc3VtZSgpO1xyXG5cclxufSk7XHJcbmFwcC5vbihhcHAuc3VzcGVuZEV2ZW50LCBmdW5jdGlvbihhcmdzKSB7XHJcbiAgY2FtZXJhUHJldmlldy5vblBhdXNlKCk7XHJcbiAgcm90VmVjdG9yLnN0b3BSb3RVcGRhdGVzKCk7XHJcbn0pO1xyXG5hcHAub24oYXBwLmV4aXRFdmVudCwgZnVuY3Rpb24oYXJncykge1xyXG4gIHJvdFZlY3Rvci5zdG9wUm90VXBkYXRlcygpO1xyXG59KTtcclxuIl19